<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S∆° ƒë·ªì l·ªõp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* nh·ªè g·ªçn ƒë·ªÉ b√†n c√≥ t·ªâ l·ªá ƒë·∫πp */
    .desk {
      width: 170px;
      height: 80px;
      min-width: 150px;
    }
    @media (max-width: 900px) {
      .desk { width: 140px; height: 72px; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-white via-sky-50 to-white min-h-screen p-6 text-gray-800">

  <div class="max-w-7xl mx-auto">
    <!-- Header: teacher (left) + title center + door (right) -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <div class="bg-yellow-100 border border-yellow-300 rounded-lg shadow px-4 py-2 text-sm font-semibold">B√†n gi√°o vi√™n</div>
        <div class="text-sm text-gray-500"> </div>
      </div>

      <h1 class="text-xl font-bold text-gray-700">S∆° ƒë·ªì l·ªõp ‚Äî 4 t·ªï √ó 6 b√†n</h1>

      <div class="flex items-center space-x-2">
        <div class="text-sm text-gray-500">C·ª≠a l·ªõp</div>
        <div class="w-8 h-8 bg-gray-100 rounded-md flex items-center justify-center text-sm text-gray-600 border">üö™</div>
      </div>
    </div>

    <!-- Main grid: 4 columns (T4 .. T1) -->
    <div id="classGrid" class="grid grid-cols-4 gap-6 justify-center"></div>

    <!-- Status -->
    <div id="status" class="mt-6 text-sm text-gray-500">K·∫øt n·ªëi t·ªõi Firestore...</div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
      <h2 id="modalTitle" class="text-lg font-semibold text-gray-700 mb-3">Ch·ªânh s·ª≠a - </h2>
      <div class="space-y-3">
        <input id="inp1" placeholder="H·ªçc sinh 1" class="w-full border rounded-md p-2 text-sm" />
        <input id="inp2" placeholder="H·ªçc sinh 2" class="w-full border rounded-md p-2 text-sm" />
      </div>
      <div class="flex justify-end mt-4 space-x-2">
        <button id="btnCancel" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm">H·ªßy</button>
        <button id="btnSave" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase (ESM CDN) - version chosen to be stable in browsers.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ====== Firebase config (project: sodolop-8c8a3) ======
    const firebaseConfig = {
      apiKey: "AIzaSyCuefMU1tBla-APHbHIE83UVLwHq83i27E",
      authDomain: "sodolop-8c8a3.firebaseapp.com",
      projectId: "sodolop-8c8a3",
      storageBucket: "sodolop-8c8a3.firebasestorage.app",
      messagingSenderId: "66493252313",
      appId: "1:66493252313:web:fdb07cdf8ce38a0f42b4c8",
      measurementId: "G-67J2WTW7EV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collRef = collection(db, "classroom");

    // DOM refs
    const classGrid = document.getElementById("classGrid");
    const statusEl = document.getElementById("status");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const inp1 = document.getElementById("inp1");
    const inp2 = document.getElementById("inp2");
    const btnSave = document.getElementById("btnSave");
    const btnCancel = document.getElementById("btnCancel");

    // Keep current editing table id
    let currentTableId = null;

    // Render layout: columns left-to-right = T4, T3, T2, T1
    function renderLayout() {
      classGrid.innerHTML = ""; // clear
      const order = [4, 3, 2, 1]; // left-to-right
      for (const t of order) {
        const col = document.createElement("div");
        col.className = "flex flex-col items-center space-y-4";
        // Column header
        const header = document.createElement("div");
        header.className = "text-sm font-medium text-gray-600 mb-1";
        header.innerText = `T·ªï ${t}`;
        col.appendChild(header);
        // 6 desks top -> bottom (B1..B6)
        for (let b = 1; b <= 6; b++) {
          const id = `T${t}-B${b}`;
          const desk = document.createElement("div");
          desk.id = id;
          desk.className = "desk bg-white rounded-lg shadow border border-gray-200 cursor-pointer hover:shadow-md transition";
          // split into two halves
          desk.innerHTML = `
            <div class="flex h-full">
              <div class="w-1/2 border-r border-gray-100 p-2 flex items-center justify-center text-xs text-gray-700" id="${id}-s1"> </div>
              <div class="w-1/2 p-2 flex items-center justify-center text-xs text-gray-700" id="${id}-s2"> </div>
            </div>
            <div class="absolute -translate-y-4 text-[11px] text-gray-500" style="margin-top: -18px; margin-left: 6px;">${id}</div>
          `;
          // position relative needed for label; apply
          desk.style.position = "relative";
          desk.onclick = () => openModalFor(id);
          col.appendChild(desk);
        }
        classGrid.appendChild(col);
      }
    }

    // Open modal for a desk
    function openModalFor(tableId) {
      currentTableId = tableId;
      const s1 = document.getElementById(`${tableId}-s1`)?.innerText || "";
      const s2 = document.getElementById(`${tableId}-s2`)?.innerText || "";
      inp1.value = s1;
      inp2.value = s2;
      modalTitle.innerText = `Ch·ªânh s·ª≠a: ${tableId}`;
      modalBackdrop.classList.remove("hidden");
      // focus first input
      setTimeout(() => inp1.focus(), 120);
    }

    function closeModal() {
      modalBackdrop.classList.add("hidden");
      currentTableId = null;
    }

    btnCancel.addEventListener("click", closeModal);

    btnSave.addEventListener("click", async () => {
      if (!currentTableId) return;
      const payload = {
        student1: inp1.value.trim(),
        student2: inp2.value.trim()
      };
      try {
        // write (merge semantics not necessary here; overwrite is fine)
        await setDoc(doc(db, "classroom", currentTableId), payload);
        statusEl.innerText = `‚úÖ ƒê√£ l∆∞u ${currentTableId}`;
      } catch (e) {
        console.error(e);
        statusEl.innerText = `‚ùå L·ªói l∆∞u: ${e.message}`;
      }
      closeModal();
    });

    // Real-time listener: update displayed names when Firestore changes
    onSnapshot(collRef, (snapshot) => {
      // clear all first (so removed docs show empty)
      // But to avoid flashing, we'll update only changed docs and also ensure empty desks are cleared
      // Build map of docs
      const docsMap = new Map();
      snapshot.forEach(docSnap => {
        docsMap.set(docSnap.id, docSnap.data());
      });

      // iterate all desks and fill
      const order = [4,3,2,1];
      for (const t of order) {
        for (let b = 1; b <= 6; b++) {
          const id = `T${t}-B${b}`;
          const el1 = document.getElementById(`${id}-s1`);
          const el2 = document.getElementById(`${id}-s2`);
          if (!el1 || !el2) continue;
          const data = docsMap.get(id);
          el1.innerText = (data && data.student1) ? data.student1 : '';
          el2.innerText = (data && data.student2) ? data.student2 : '';
        }
      }

      statusEl.innerText = `üü¢ ƒê·ªìng b·ªô v·ªõi Firestore ‚Äî c·∫≠p nh·∫≠t ${snapshot.size} b·∫£n ghi`;
    }, (err) => {
      console.error('Listen error', err);
      statusEl.innerText = `‚ùå L·ªói k·∫øt n·ªëi Firestore: ${err.message}`;
    });

    // initial render
    renderLayout();
  </script>
</body>
</html>
