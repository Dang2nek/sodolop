<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S∆° ƒë·ªì l·ªõp - 4 t·ªï √ó 6 b√†n</title>
  <!-- Tailwind CDN (ok ƒë·ªÉ d√πng nhanh; b·ªè qua c·∫£nh b√°o khi deploy) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* T·ªâ l·ªá b√†n hi·ªÉn th·ªã ƒë·∫πp */
    .desk {
      width: 180px;
      height: 90px;
      min-width: 150px;
    }
    .teacher-desk {
      width: 220px;
      height: 110px;
    }
    .door {
      width: 110px;
      height: 60px;
    }
    @media (max-width: 900px) {
      .desk { width: 140px; height: 72px; }
      .teacher-desk { width: 160px; height: 88px; }
      .door { width: 90px; height: 52px; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-white via-sky-50 to-white min-h-screen p-6 text-gray-800">
  <div class="max-w-7xl mx-auto">
    <!-- Header: teacher (left) + title + door (right) -->
    <div class="flex items-center justify-between mb-6">
      <!-- Teacher desk (top-left, larger) -->
      <div class="flex items-center space-x-3">
        <div id="teacherDesk" class="teacher-desk bg-yellow-50 border border-yellow-200 rounded-xl shadow-md flex flex-col items-center justify-center p-3">
          <div class="text-sm font-semibold text-gray-700">B√†n gi√°o vi√™n</div>
          <div class="text-xs text-gray-500 mt-1">(kh√¥ng s·ª≠a)</div>
        </div>
      </div>

      <h1 class="text-xl font-bold text-gray-700">S∆° ƒë·ªì l·ªõp ‚Äî 4 t·ªï √ó 6 b√†n</h1>

      <!-- Door (top-right, larger) and teacher-mode indicator -->
      <div class="flex items-center space-x-4">
        <div id="teacherStatus" class="text-sm text-gray-600">Quy·ªÅn: <span id="roleLabel">Kh√°ch</span></div>
        <div id="doorBox" class="door bg-gray-100 border border-gray-200 rounded-md shadow flex items-center justify-center text-sm text-gray-700">
          üö™<span class="ml-2 hidden sm:inline">C·ª≠a l·ªõp</span>
        </div>
      </div>
    </div>

    <!-- Main area: spacing between groups (each column is 1 t·ªï) -->
    <div class="mb-3 text-sm text-gray-500">G·ª£i √Ω: Click v√†o b√†n ƒë·ªÉ s·ª≠a (ch·ªâ gi√°o vi√™n ƒë∆∞·ª£c ch·ªânh). N·∫øu b·∫°n ch∆∞a x√°c th·ª±c, h·ªá th·ªëng s·∫Ω h·ªèi m√£ gi√°o vi√™n m·ªôt l·∫ßn.</div>

    <div id="gridWrap" class="flex flex-row gap-10 justify-center">
      <!-- We'll dynamically insert 4 columns (T4..T1) with spacing between -->
    </div>

    <!-- Status -->
    <div id="status" class="mt-6 text-sm text-gray-500">K·∫øt n·ªëi t·ªõi Firestore...</div>

    <!-- Small control: logout teacher -->
    <div class="mt-4">
      <button id="logoutBtn" class="px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">ƒêƒÉng xu·∫•tGV</button>
    </div>
  </div>

  <!-- Modal (center) -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
      <h2 id="modalTitle" class="text-lg font-semibold text-gray-700 mb-3">Ch·ªânh s·ª≠a</h2>
      <div class="space-y-3">
        <input id="inp1" placeholder="H·ªçc sinh 1" class="w-full border rounded-md p-2 text-sm" />
        <input id="inp2" placeholder="H·ªçc sinh 2" class="w-full border rounded-md p-2 text-sm" />
      </div>
      <div class="flex justify-end mt-4 space-x-2">
        <button id="btnCancel" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm">H·ªßy</button>
        <button id="btnSave" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase (ESM CDN) - same major as previously used
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ====== Firebase config (project: sodolop-8c8a3) ======
    const firebaseConfig = {
      apiKey: "AIzaSyCuefMU1tBla-APHbHIE83UVLwHq83i27E",
      authDomain: "sodolop-8c8a3.firebaseapp.com",
      projectId: "sodolop-8c8a3",
      storageBucket: "sodolop-8c8a3.firebasestorage.app",
      messagingSenderId: "66493252313",
      appId: "1:66493252313:web:fdb07cdf8ce38a0f42b4c8",
      measurementId: "G-67J2WTW7EV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collRef = collection(db, "classroom");

    // DOM refs
    const gridWrap = document.getElementById("gridWrap");
    const statusEl = document.getElementById("status");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const inp1 = document.getElementById("inp1");
    const inp2 = document.getElementById("inp2");
    const btnSave = document.getElementById("btnSave");
    const btnCancel = document.getElementById("btnCancel");
    const roleLabel = document.getElementById("roleLabel");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentTableId = null;

    // Teacher auth: check localStorage
    function isTeacher() {
      return localStorage.getItem("isTeacher") === "1";
    }
    function setTeacher(flag) {
      if (flag) localStorage.setItem("isTeacher", "1");
      else localStorage.removeItem("isTeacher");
      updateRoleLabel();
    }
    function updateRoleLabel() {
      roleLabel.innerText = isTeacher() ? "Gi√°o vi√™n" : "Kh√°ch";
      roleLabel.className = isTeacher() ? "text-green-600 font-semibold" : "text-gray-600";
    }

    logoutBtn.addEventListener("click", () => {
      setTeacher(false);
      alert("ƒê√£ ƒëƒÉng xu·∫•t quy·ªÅn gi√°o vi√™n. B·∫°n l√† Kh√°ch.");
    });

    // Render layout with spacing between groups (left-to-right: T4, T3, T2, T1)
    function renderLayout() {
      gridWrap.innerHTML = "";
      const order = [4,3,2,1]; // left-to-right
      order.forEach(t => {
        const col = document.createElement("div");
        col.className = "flex flex-col items-center gap-4";
        // group header spacing
        const header = document.createElement("div");
        header.className = "text-sm font-medium text-gray-600 mb-1";
        header.innerText = `T·ªï ${t}`;
        col.appendChild(header);

        for (let b = 1; b <= 6; b++) {
          const id = `T${t}-B${b}`;
          const desk = document.createElement("div");
          desk.id = id;
          desk.className = "desk bg-white rounded-lg shadow border border-gray-200 cursor-pointer hover:shadow-md transition relative overflow-hidden";
          desk.style.display = "flex";
          desk.style.flexDirection = "column";
          // two halves horizontally
          desk.innerHTML = `
            <div class="flex flex-row h-full">
              <div class="w-1/2 border-r border-gray-100 p-2 flex items-center justify-center text-xs text-gray-700" id="${id}-s1"></div>
              <div class="w-1/2 p-2 flex items-center justify-center text-xs text-gray-700" id="${id}-s2"></div>
            </div>
            <div class="absolute -top-4 left-2 text-[11px] text-gray-500">${id}</div>
          `;

          desk.onclick = (ev) => {
            // prevent accidental double click from clicking inner elements
            ev.stopPropagation();
            tryOpenEditorFor(id);
          };

          col.appendChild(desk);
        }

        // add some horizontal spacing container wrapper so there is visible gap between groups
        const wrapper = document.createElement("div");
        wrapper.appendChild(col);
        gridWrap.appendChild(wrapper);
      });
    }

    // Try open editor: ask auth once if needed
    async function tryOpenEditorFor(tableId) {
      if (!isTeacher()) {
        // ask once via prompt
        const code = prompt("Nh·∫≠p m√£ gi√°o vi√™n ƒë·ªÉ cho ph√©p ch·ªânh s·ª≠a (m√£ l√† gv123):");
        if (code === null) {
          // user cancelled
          return;
        }
        if (code.trim() === "gv123") {
          setTeacher(true);
          alert("X√°c th·ª±c th√†nh c√¥ng ‚Äî b·∫°n c√≥ quy·ªÅn ch·ªânh s·ª≠a.");
        } else {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a (m√£ kh√¥ng ƒë√∫ng).");
          return;
        }
      }
      // open modal
      openModalFor(tableId);
    }

    function openModalFor(tableId) {
      currentTableId = tableId;
      const s1 = document.getElementById(`${tableId}-s1`)?.innerText || "";
      const s2 = document.getElementById(`${tableId}-s2`)?.innerText || "";
      inp1.value = s1;
      inp2.value = s2;
      modalTitle.innerText = `Ch·ªânh s·ª≠a: ${tableId}`;
      modalBackdrop.classList.remove("hidden");
      setTimeout(() => inp1.focus(), 120);
    }

    function closeModal() {
      modalBackdrop.classList.add("hidden");
      currentTableId = null;
    }

    btnCancel.addEventListener("click", closeModal);

    btnSave.addEventListener("click", async () => {
      if (!currentTableId) return;
      if (!isTeacher()) {
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u (m√£ GV ch∆∞a x√°c th·ª±c).");
        closeModal();
        return;
      }
      const payload = {
        student1: inp1.value.trim(),
        student2: inp2.value.trim()
      };
      try {
        await setDoc(doc(db, "classroom", currentTableId), payload);
        statusEl.innerText = `‚úÖ ƒê√£ l∆∞u ${currentTableId}`;
      } catch (e) {
        console.error(e);
        statusEl.innerText = `‚ùå L·ªói l∆∞u: ${e.message}`;
        alert("L·ªói khi l∆∞u d·ªØ li·ªáu: " + e.message);
      }
      closeModal();
    });

    // Realtime listener
    function initRealtime() {
      onSnapshot(collRef, (snapshot) => {
        // Build map for quick lookup
        const docsMap = new Map();
        snapshot.forEach(ds => docsMap.set(ds.id, ds.data()));

        const order = [4,3,2,1];
        for (const t of order) {
          for (let b = 1; b <= 6; b++) {
            const id = `T${t}-B${b}`;
            const el1 = document.getElementById(`${id}-s1`);
            const el2 = document.getElementById(`${id}-s2`);
            if (!el1 || !el2) continue;
            const data = docsMap.get(id);
            el1.innerText = (data && data.student1) ? data.student1 : "";
            el2.innerText = (data && data.student2) ? data.student2 : "";
          }
        }

        statusEl.innerText = `üü¢ ƒê·ªìng b·ªô v·ªõi Firestore ‚Äî ${snapshot.size} b·∫£n ghi`;
      }, (err) => {
        console.error("Listen error", err);
        statusEl.innerText = `‚ùå L·ªói k·∫øt n·ªëi Firestore: ${err.message}`;
      });
    }

    // initial
    renderLayout();
    updateRoleLabel();
    initRealtime();

  </script>
</body>
</html>
